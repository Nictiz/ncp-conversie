<?xml version="1.0" encoding="UTF-8"?>
<!-- 
    Author: Marc de Graauw, Linda Mook 2024 
-->
<xsl:stylesheet version="3.0" exclude-result-prefixes="xsl dm" 
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:hl7="urn:hl7-org:v3"  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="urn:hl7-org:v3" xmlns:dm="http://duometis.nl/functions" xmlns:nf="http://www.nictiz.nl/functions" 
    xmlns:fn="http://www.w3.org/2005/xpath-functions" xmlns:map="http://www.w3.org/2005/xpath-functions/map" xmlns:array="http://www.w3.org/2005/xpath-functions/array" 
    xmlns:xs="http://www.w3.org/2001/XMLSchema">

    <!-- Converts Xpath (ISO-formatted) time to HL7 time -->
    <xsl:function name="dm:formatTS">
        <xsl:param name="datetime" as="xs:dateTime"/>
		<xsl:value-of select="format-dateTime($datetime, '[Y0001][M01][D01][H01][m01][s01][Z]')"/>
    </xsl:function>
    
    <xsl:function name="dm:formatHl7date">
        <xsl:param name="hl7ts"/>
        <xsl:variable name="date">
        <xsl:value-of select="fn:substring($hl7ts, 1, 4)"/>
        <xsl:value-of select="'-'"/>
        <xsl:value-of select="fn:substring($hl7ts, 5, 2)"/>
        <xsl:value-of select="'-'"/>
        <xsl:value-of select="fn:substring($hl7ts, 7, 2)"/>
        </xsl:variable>
        <xsl:variable name="time">
            <xsl:if test="fn:string-length($hl7ts) > 8">
                <xsl:value-of select="fn:substring($hl7ts, 9, 2)"/>
                <xsl:value-of select="':'"/>
                <xsl:value-of select="fn:substring($hl7ts, 11, 2)"/>
            </xsl:if>  
        </xsl:variable>
        <xsl:choose>
            <xsl:when test="fn:string-length($hl7ts) > 8">
                <xsl:value-of select="concat($date, ' ', $time)"/>
            </xsl:when>
            <xsl:when test="fn:string-length($hl7ts) > 1">
                <xsl:value-of select="$date"/>
            </xsl:when>
            <xsl:otherwise>
                <xsl:value-of select="$hl7ts"/>                
            </xsl:otherwise>
        </xsl:choose>
    </xsl:function>

    <!-- Get the refID (i.e. strip '#' from '#dada') -->
    <xsl:function name="dm:getRefID">
        <xsl:param name="element"/>
        <xsl:value-of select="substring($element/hl7:text/hl7:reference/@value, 2)"/>
    </xsl:function>
    
    <!-- This function compares an HL7 date (usually effectiveTime/high) to now to see if it's in the future.
    Strip current-dateTime() down to a HL7 style date string ('202411211629' or '2024' or something, make it the same length as input date and compare.
    true if date is empty, if date >= now
    false otherwise-->
    <xsl:function name="dm:isFuture" as="xs:boolean">
        <xsl:param name="date"/>
        <xsl:choose>
            <xsl:when test="string-length($date) = 0">
                <xsl:value-of select="true()"/>
            </xsl:when>
            <xsl:otherwise>
                <xsl:variable name="nowstring" select="substring(translate(xs:string(current-dateTime()), '-:.+T', ''), 1, string-length($date))"/>
                <xsl:value-of select="$date >= $nowstring"/>
            </xsl:otherwise>
        </xsl:choose>
    </xsl:function>
</xsl:stylesheet>
